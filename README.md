# 健康体检报告生成器

基于员工表、体检原始资料和 PPT 模板，自动为每位员工生成个性化的体检报告 PPT，支持多种体检资料格式和智能排版。

## 项目概述

本项目是一个自动化体检报告生成工具，能够根据员工表和体检资料，自动生成包含封面、影像资料和 AI 总结的完整体检报告 PPT。项目支持多种体检资料格式，包括图片、PDF 和 Word 文档，并能自动将 PDF 转换为图片插入到 PPT 中。

## 技术栈

- **Node.js**：运行环境
- **ExcelJS**：解析员工表 Excel 文件
- **PptxGenJS**：生成 PPT 文件
- **mammoth**：提取 Word 文档文本
- **pdf2pic**：将 PDF 转换为图片
- **pdfjs-dist**：PDF 渲染（备用方案）
- **canvas**：图片处理
- **fs-extra**：文件系统操作
- **pizzip**：处理 PPTX 文件结构

## 项目结构

```
health_manage_ai/
├── data/                 # 体检原始资料目录
│   └── 姓名-证件号-类型.扩展名  # 体检文件命名规范
├── output/               # 生成的PPT报告输出目录
├── 员工表.xlsx           # 员工信息表
├── 2025员工体检报告（模板）.pptx  # PPT模板
├── merged.js             # 主程序文件
├── package.json          # 项目依赖配置
└── README.md             # 项目说明文档
```

## 快速开始

- npm start ：运行主程序，生成个性化体检报告 PPT
- npm run rename-ppt-files ：为 PPT 文件添加证件号
- npm run convert-ppt-pdf ：将 PPT 转换为 PDF
- npm run send-wechat-ee-msg ：从 PDF 提取 ID 并发送微信企业消息

### 1. 安装依赖

```bash
npm install
```

### 2. 准备数据

- **员工表.xlsx**：包含员工基本信息，至少需要 `姓名`和 `证件号`列
- **体检资料**：将所有体检资料放入 `data/`目录，按照 `姓名-证件号-类型.扩展名`命名
- **PPT 模板**：确保 `2025员工体检报告（模板）.pptx`文件存在

### 3. 运行程序

```bash
npm start
```

### 4. 重命名 result_add_suggest 文件夹中的 PPT 文件

如果需要为 `result_add_suggest`文件夹中的 PPT 文件添加证件号，可以使用以下命令：

```bash
npm run rename-ppt-files
```

该命令会：

- 遍历 `result_add_suggest`文件夹中的所有 PPT 文件
- 从文件名中提取员工姓名
- 在员工表中查询对应的证件号
- 将证件号添加到文件名中，格式为 `体检报告_姓名_证件号.pptx`
- 跳过无法匹配或已包含证件号的文件

### 5. 修改 result_add_suggest 文件夹中的 PPT 文件为 pdf

如果需要为 `result_add_suggest`文件夹中的 PPT 文件改为 pdf，可以使用以下命令：

```bash
npm run convert-ppt-pdf
```

该命令会：

- 遍历 `result_add_suggest`文件夹中的所有 PPT 文件
- 改为 pdf 输出

### 6. 查看结果

生成的 PPT 报告将输出到 `output/`目录，文件名格式为 `员工体检报告_姓名_HHMM.pptx`，重名员工会自动添加数字后缀。

## 数据约定

### 员工表.xlsx

- 首行为表头，至少包含以下列：
  - `姓名`：员工姓名
  - `证件号`：员工身份证号
  - 可选列：`性别`、`年龄`、`体检日期`等

### 体检资料文件命名规范

所有体检资料文件必须按照以下格式命名：

```
姓名-证件号-类型.扩展名
```

例如：

- `王磊-12022519860808003X-血检.pdf`
- `王磊-12022519860808003X-总结.docx`
- `王磊-12022519860808003X-心电图.jpg`

### 支持的文件类型

- **图片类**：.png, .jpg, .jpeg, .gif, .bmp
- **PDF 类**：.pdf（会自动转换为图片）
- **Word 类**：.docx（用于 AI 总结）

## 生成内容

### 1. 封面

包含员工基本信息、文件统计和 AI 总结概览，自动填充模板中的占位符。

### 2. 影像幻灯片

根据体检资料类型自动分类排版：

- **InBody**：身体成分分析报告
- **实验室检查**：尿检、血检、生化检查、糖化血红蛋白等
- **心电图**：心电图报告
- **AI 解读**：AI 生成的解读报告

文件处理顺序：

1. inbody
2. 尿检
3. 血常规
4. 生化检查
5. 糖化血红蛋白
6. 心电图
7. AI 解读

### 3. AI 总结详情

从 Word 文档中提取的 AI 总结文本，自动分段排版，保持良好的可读性。

## 实现要点

### 1. 精准匹配机制

- 使用"姓名+证件号"组合作为唯一标识符，确保员工与体检资料精准匹配
- 支持重名员工，生成的文件名会自动添加数字后缀

### 2. 智能文件处理

- 图片类文件直接插入 PPT
- PDF 类文件通过 pdf2pic 转换为图片，转换失败时自动使用 pdfjs-dist 作为备用方案
- Word 类文件通过 mammoth 提取文本内容

### 3. 模板复用与定制

- 自动读取模板的页面尺寸和方向，保持与模板一致的版式
- 支持从模板中复制幻灯片布局和样式
- 自动替换模板中的文本和图片占位符

### 4. 错误处理与日志

- 缺少必要文件时给出控制台告警
- 生成失败时记录详细错误信息
- 生成完成后输出统计信息，包括成功和失败的员工列表

### 5. 性能优化

- 支持 500+员工顺序处理
- 影像页采用"contain"策略插入图片，自动保留宽高比
- 生成的 PPT 文件采用 DEFLATE 压缩，减小文件大小

## 常见问题与注意事项

1. **PDF 转换失败**：确保系统已安装 Ghostscript 和 GraphicsMagick（pdf2pic 依赖）
2. **模板格式问题**：使用标准 PPTX 格式模板，确保包含所有必要的幻灯片布局
3. **文件名编码**：确保文件名使用 UTF-8 编码，避免特殊字符
4. **员工信息匹配**：确保员工表中的姓名和证件号与体检资料文件名完全一致
5. **输出目录**：程序会自动创建 output 目录，无需手动创建

- **图片类**：.png, .jpg, .jpeg, .gif, .bmp
- **PDF 类**：.pdf（会自动转换为图片）
- **Word 类**：.docx（用于 AI 总结）

## 生成内容

### 1. 封面

包含员工基本信息、文件统计和 AI 总结概览，自动填充模板中的占位符。

### 2. 影像幻灯片

根据体检资料类型自动分类排版：

- **InBody**：身体成分分析报告
- **实验室检查**：尿检、血检、生化检查、糖化血红蛋白等
- **心电图**：心电图报告
- **AI 解读**：AI 生成的解读报告

文件处理顺序：

1. inbody
2. 尿检
3. 血常规
4. 生化检查
5. 糖化血红蛋白
6. 心电图
7. AI 解读

### 3. AI 总结详情

从 Word 文档中提取的 AI 总结文本，自动分段排版，保持良好的可读性。

## 实现要点

### 1. 精准匹配机制

- 使用"姓名+证件号"组合作为唯一标识符，确保员工与体检资料精准匹配
- 支持重名员工，生成的文件名会自动添加数字后缀

### 2. 智能文件处理

- 图片类文件直接插入 PPT
- PDF 类文件通过 pdf2pic 转换为图片，转换失败时自动使用 pdfjs-dist 作为备用方案
- Word 类文件通过 mammoth 提取文本内容

### 3. 模板复用与定制

- 自动读取模板的页面尺寸和方向，保持与模板一致的版式
- 支持从模板中复制幻灯片布局和样式
- 自动替换模板中的文本和图片占位符

### 4. 错误处理与日志

- 缺少必要文件时给出控制台告警
- 生成失败时记录详细错误信息
- 生成完成后输出统计信息，包括成功和失败的员工列表

### 5. 性能优化

- 支持 500+员工顺序处理
- 影像页采用"contain"策略插入图片，自动保留宽高比
- 生成的 PPT 文件采用 DEFLATE 压缩，减小文件大小

## 工作流程

1. **数据准备**：准备员工表和体检资料
2. **数据加载**：读取员工表和体检资料文件
3. **员工匹配**：将员工与对应的体检资料进行匹配
4. **文件处理**：处理不同类型的体检资料（图片、PDF、Word）
5. **PPT 生成**：根据模板生成个性化体检报告 PPT
6. **模板注入**：将生成的内容注入到模板中
7. **输出结果**：将生成的 PPT 输出到指定目录
8. **可选转换**：将 PPT 转换为 PDF（如果需要）

## 配置说明

### 环境变量

- **LIBREOFFICE_PATH**：LibreOffice 安装路径（可选，自动检测）
- **SOFFICE_PATH**：soffice.exe 路径（可选，自动检测）

### 程序配置

在 `merged.js`文件中可以修改以下配置：

```javascript
// 是否带第六页指导页
const has6WhitePage = false
// PDF 生成文件类型开关 设置为 true 开启 PDF 转换，false 则关闭
const generatePdf = true
// name中加入id开关 false 不添加 true 添加
const addId = true
```

## 常见问题与注意事项

1. **PDF 转换失败**：确保系统已安装 Ghostscript 和 GraphicsMagick（pdf2pic 依赖）
2. **PPT 转 PDF 失败**：确保已安装 LibreOffice，并且其路径已添加到系统环境变量
3. **模板格式问题**：使用标准 PPTX 格式模板，确保包含所有必要的幻灯片布局
4. **文件名编码**：确保文件名使用 UTF-8 编码，避免特殊字符
5. **员工信息匹配**：确保员工表中的姓名和证件号与体检资料文件名完全一致
6. **输出目录**：程序会自动创建 output 目录，无需手动创建
7. **内存占用**：处理大量员工时可能会占用较多内存，建议分批处理

## 故障排除

### 1. PDF 转换失败

- 检查 Ghostscript 和 GraphicsMagick 是否已正确安装
- 检查 PDF 文件是否损坏
- 尝试使用较小的 PDF 文件进行测试

### 2. PPT 生成失败

- 检查模板文件是否完整
- 检查员工表格式是否正确
- 检查体检资料文件名是否符合规范

### 3. PPT 转 PDF 失败

- 检查 LibreOffice 是否已正确安装
- 检查 LibreOffice 版本是否支持 PPT 转 PDF
- 尝试手动使用 LibreOffice 转换一个 PPT 文件，确认其正常工作
